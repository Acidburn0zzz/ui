box: node:4

build:
  steps:
    - npm-install
    - thangngoc89/bower-install@0.5.8
    - aussiegeek/install-phantomjs@0.0.4
    - npm-test
    # Production asset build
    - thriqon/ember-build@0.1.1

deploy:
  steps:
    # Add our deploy key to SSH
    - add-ssh-key:
      keyname: GIT_KEY

    - install-packages:
      packages: openssh-client

    # Add GitHub's SSH fingerprint to SSH known_hosts
    - add-to-known_hosts:
      hostname: github.com
      fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
      type: rsa

    - script:
      name: bundle static files
      code: tar -cvzf sdui.tgz ${WERCKER_ROOT}/dist

    - script:
      name: get highest version from tags
      code: git tag
      
    - script:
      name: get highest version from tags
      code: ./bin/incrementVersion.sh

    - script:
      name: get highest version from tags
      code: export VERSION=$(bash bin/incrementVersion.sh)

    - script:
      name: add new tag
      code: git tag $VERSION

    - script:
      name: push newly added tag
      code: git push origin $VERSION

    - github-create-release:
      token: $GITHUB_TOKEN
      tag: $VERSION

    - github-upload-asset:
      token: $GITHUB_TOKEN
      file: sdui.tgz
      content_type: application/octet-stream
